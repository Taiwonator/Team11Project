<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../public/styles/navs.css">
    <link rel="stylesheet" href="../../public/styles/index.css">
    <title>Active Problems</title>
    
</head>
<body>

    <nav class='top-nav'>
        <div class="top-nav-left">
            <h2 class="top-nav-company">Make-It-All</h2>
        </div>
        <div class="top-nav-right">
            <h3 class="top-nav-text">Welcome Operator</h3>
            <h3 class="top-nav-button"><a href="../../login.html">Logout</a></h3>
        </div>
    </nav>
    
    <nav id='operator-side-nav'></nav>

    <div class="page">
        <div class="page-content scroll">
            <h1 class="title"><i class="fa fa-list"></i> Active Problems</h1>
            <div class="search-element">
                <h3 class="element-title">Active Problems</h3>
                <div class="search-element-bar">
                    <input type="text" placeholder="Enter problem ID" onkeyup="searchTable(event, 0)" >
                    <button><i class="fa fa-search"></i></button>
                </div>
                <div class="search-element-table-wrapper">
                <table class="search-element-table" id="active-problems-table">
                    <tr>
                        <th>Problem No.</th>
                        <th>Problem Description</th>
                        <th>Problem Type</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </table>
                </div>
                <button onclick="loadEmail()" id="exit-button" class="big-button confirm-edit">Email</button>
            </div>
        </div>
        
        <div id="edit-screen" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
              <span class="close">&times;</span>
              <h1 class="title"><i class="fa fa-edit"></i> View Problem</h1>
    
    
               <!-- DESCRIPTION -->
            <div class="text-area-input-element">
                <h3 class="element-title">Problem Description</h3>
                <textarea id="problem-description-input" class="scroll"></textarea>
            </div>
    
            <!-- SOLVE METHOD -->
            <div class="text-area-input-element">
                <h3 class="element-title">How it was solved?</h3>
                <textarea id="solve-method-input" class="scroll"></textarea>
            </div>
    
            <!-- NOTES -->
            <div class="text-area-input-element">
                <h3 class="element-title">Notes</h3>
                <textarea id="notes-input" class="scroll"></textarea>
            </div>
    
            <!-- EQUIPMENT -->
            <div class="search-element">
                <h3 class="element-title">Equipment</h3>
                <div class="search-element-bar">
                    <input type="text" placeholder="Enter Serial Number" onkeyup="searchTable(event, 0)"> 
                    <button><i class="fa fa-search"></i></button>
                </div>
                <table id="equipment-table" class="search-element-table">
                    <tr>
                        <th>Serial No.</th>
                        <th>Type</th>
                        <th>Make</th>
                    </tr>
                    <tr>
                        <td>1234</td>
                        <td>Monitor</td>
                        <td>Asos</td>
                    </tr>
                </table>
            </div>
    
            <!-- SOFTWARE -->
            <div class="search-element">
                <h3 class="element-title">Software</h3>
                <div class="search-element-bar">
                    <input type="text" placeholder="Enter Software Name" onkeyup="searchTable(event, 0)"> 
                    <button><i class="fa fa-search"></i></button>
                </div>
                <table id="software-table" class="search-element-table">
                    <tr>
                        <th>Software Name</th>
                        <th>Licensed</th>
                        <th>Supported</th>
                    </tr>
                    <tr>
                        <td>Microsoft Word</td>
                        <td><i class="fa fa-check-square"></i></td>
                        <td><i class="fa fa-check-square"></i></td>
                    </tr>
                </table>
            </div>
    
            <!-- BRANCH -->
            <div class="search-element">
                <h3 class="element-title">Branch</h3>
                <div class="search-element-bar">
                    <input type="text" placeholder="Enter City" onkeyup="searchTable(event, 2)"> 
                    <button><i class="fa fa-search"></i></button>
                </div>
                <table id="branch-table" class="search-element-table">
                    <tr>
                        <th>Branch ID</th>
                        <th>Branch Name</th>
                        <th>City</th>
                        <th>Country</th>
                        <th>Telephone</th>
                    </tr>
                </table>
            </div>
    
            <!-- PROBLEM TYPE -->
            <div class="element-row">
                <div class="select-input-element">
                    <h3 class="element-title">Problem Type</h3>
                    <select id="problem-type-input"> 
                        <option value="" selected disabled hidden>Select a problem type</option>
                        <optgroup label="Printer">
                            <option>Printer</option>
                            <option>Printer Ink</option>
                            <option>Printer Paper</option>
                        </optgroup>
                        <optgroup label="Hardware">
                            <option>Hardware</option>
                            <option>GPU</option>
                            <option>RAM</option>
                        </optgroup>
                    </select>
                </div>
    
                <!-- OS -->
                <div class="select-input-element">
                    <h3 class="element-title">Operating System</h3>
                    <select id="os-input">
                        <option value="" selected disabled hidden>Select an OS</option>
                        <option>Windows</option>
                        <option>iOS</option>
                        <option>Linux</option>
                        <option value="">Doesn't require OS</option>
                    </select>
                </div>
            </div>
    
            <!-- PRIORITY -->
            <div class="element-row">
                <div class="select-input-element">
                    <h3 class="element-title">Priority</h3>
                    <select id="priority-input">
                        <option value="" selected disabled hidden>Select Priority</option>
                        <option>Low</option>
                        <option>Medium</option>
                        <option>High</option>
                        <option value="">I don't know</option>
                    </select>
                </div>
    
            <!-- IN PERSON -->
            <div class="checkbox-input-element">
                <h3 class="element-title">In Person Solving</h3>
                <input type="checkbox" id="in-person-input" value="in-person">
                <label>Problem must be solved in person</label>
            </div>
    
            <!-- SPECIALIST -->
            <div class="search-element" id="specialist-element">
                <h3 onclick="getInputs()" class="element-title">Specialist </h3>
                <input type="checkbox" id="external-checkbox" value="external">
                <label>3rd party specialist</label>
                
                <div id="specialist-form" class="">
                    <div class="search-element-bar">
                        <input type="text" placeholder="Enter Expertise" onkeyup="searchTable(event, 1)"> 
                        <button><i class="fa fa-search"></i></button>
                    </div>
    
                    <table id="specialist-table" class="search-element-table">
                        <tr>
                            <th>Specialist ID</th>
                            <th>Specialist Name</th>
                            <th>Expertise</th>
                        </tr>
                    </table>

                </div>
                
                
                <div id="external-specialist-form"  class="hide-form">
                    <div class="search-element-bar">
                        <input type="text" placeholder="Enter Expertise" onkeyup="searchTable(event, 3)"> 
                        <button><i class="fa fa-search"></i></button>
                    </div>
                <table id="external-specialist-table" class="search-element-table">
                    <tr>
                        <th>Specialist ID</th>
                        <th>Specialist Name</th>
                        <th>Expertise</th>
                    </tr>
                </table>
            </div>

                
            </div>
    
                <button onclick="confirmEdit()" id="exit-button" class="big-button confirm-edit">Exit</button>
              
            </div>


        </div>
    
        <script src="../../public/js/ajaxFunctions.js"></script>
        <script>

        function loadEmail() {
                loadData('GET', '../php/email.php', {}, function(json){
                   console.log(json);
                })
            }
    
            var data = {};
            var activeProblemsTable = document.getElementById("active-problems-table");
            var modal = document.getElementById("edit-screen");
            var span = document.getElementsByClassName("close")[0]; // close button
    
            var problemDescriptionInput = document.getElementById("problem-description-input");
            var solveMethodInput = document.getElementById("solve-method-input");
            var notesInput = document.getElementById("notes-input");
            var equipmentTable = document.getElementById("equipment-table");
            var softwareTable = document.getElementById("software-table");
            var branchTable = document.getElementById("branch-table");
            var problemTypeInput = document.getElementById("problem-type-input");
            var osInput = document.getElementById("os-input");
            var priorityInput = document.getElementById("priority-input");
            var inPersonInput = document.getElementById("in-person-input");

            var specialistElement = document.getElementById("specialist-element");
            var specialistTable = document.getElementById("specialist-table");
            var specialistForm = document.getElementById("specialist-form");
            var externalSpecialistTable = document.getElementById("external-specialist-table");
            var externalSpecialistForm = document.getElementById("external-specialist-form");
            var externalCheckbox = document.getElementById("external-checkbox");
            var external = false;

            externalCheckbox.onclick = function(e) {
                if(e.target.checked) {
                    external = true;
                    if(externalSpecialistForm.classList.contains("hide-form")) {
                        externalSpecialistForm.classList.remove("hide-form");
                    }
                    if(!specialistForm.classList.contains("hide-form")) {
                        specialistForm.classList.add("hide-form");
                    }
                } else {
                    external = false;
                    if(specialistForm.classList.contains("hide-form")) {
                        specialistForm.classList.remove("hide-form");
                    }
                    if(!externalSpecialistForm.classList.contains("hide-form")) {
                        externalSpecialistForm.classList.add("hide-form");
                    }
                }
            }

    
            span.onclick = function() {
                modal.style.display = "none";
            }
    
            document.getElementById("exit-button").onclick = function() {
                modal.style.display = "none";
            }
    
            function loadActiveSolutions() {
                loadData('GET', '../php/activeProblems/sql_select_activeProblems.php', {}, function(json){
                    data.activeProblems = JSON.parse(json);
                    console.log(data);
    
                    activeProblemsTable.innerHTML = `<tr> 
                                                          <th>Problem No.</th>
                                                          <th>Problem Description</th>
                                                          <th>Problem Type</th>
                                                          <th>Priority</th>
                                                          <th>Actions</th>
                                                        </tr>
                                                        ${generateActiveSolutionsTable(json)}`;
    
                })
            }

            function refreshPage() {
                loadActiveSolutions();
                loadBranches();
                loadEquipment();
                loadSoftware();
                loadSpecialists();
                loadExternalSpecialists();
                loadProblemTypes();
            }

            refreshPage();

    
            function loadBranches() {
                loadData('GET', '../../public/php/sql_select_branches.php', {}, function(json){
                    data.branches = JSON.parse(json);
                    console.log(data);
                })
            }
    
            function loadEquipment() {
                loadData('GET', '../../public/php/sql_select_equipment.php', {}, function(json){
                    data.equipment = JSON.parse(json);
                    console.log(data);
                })
            }
    
            function loadSoftware() {
                loadData('GET', '../../public/php/sql_select_software.php', {}, function(json){
                    data.software = JSON.parse(json);
                    console.log(data);
                })
            }
    
            function loadSpecialists() {
                loadData('GET', '../../public/php/sql_select_specialists.php', {}, function(json){
                    data.specialists = JSON.parse(json);
                    console.log(data);
                })
            }
    
            function loadExternalSpecialists() {
                loadData('GET', '../../public/php/sql_select_externalSpecialists.php', {}, function(json){
                    data.externalSpecialists = JSON.parse(json);
                    console.log(data);
                })
            }

            function loadProblemTypes() {
                loadData('GET', '../../public/php/sql_select_problemType.php', {}, function(json){
                    data.problemTypes = JSON.parse(json);
                    console.log(data);
                    problemTypeInput.innerHTML = generateProblemTypesDropdown();
                })
            }
    
            function generateActiveSolutionsTable(json) {
                return generateTable(json, (problem) => {
                    return `<tr>
                                <td>${problem.problemNumber}</td>
                                <td>${problem.description}</td>
                                <td>${problem.problemType}</td>
                                <td>${(problem.priority == null) ? "Not sure" : problem.priority}</td>
                                <td>
                                    <button onclick="viewProblem(${problem.problemNumber})" class="edit-button">Edit / Reassign</button>
                                    <button onclick="reportSolved(${problem.problemNumber})" class="report-solved-button">Report Solved</button>
                                </td>`
                })
            }
    
            function generateEquipmentTable(serialNumber) {
                    let output = ``;
                    for(var i = 0; i < data.equipment.length; i++) {
                        if(data.equipment[i].serialNumber == serialNumber) {
    
                            let equipment = data.equipment[i];
                            output += `<tr class="selected-row">
                                        <td>${equipment.serialNumber}</td>
                                        <td>${equipment.type}</td>
                                        <td>${equipment.make}</td>
                                    </tr>`;
    
                        } else {
                            let equipment = data.equipment[i];
                            output += `<tr>
                                        <td>${equipment.serialNumber}</td>
                                        <td>${equipment.type}</td>
                                        <td>${equipment.make}</td>
                                    </tr>`;
                        }
                    }
                    addSelectableRows();
                    return output;
                
            }
    
            function generateSoftwareTable(softwareName) {
                    let output = ``;
                    for(var i = 0; i < data.software.length; i++) {
                        if(data.software[i].softwareName == softwareName) {
    
                            let software = data.software[i];
                            output += `<tr class="selected-row">
                                        <td>${software.softwareName}</td>
                                        ${(software.licensed == 1) ? '<td><i class="fa fa-check-square"></i></td>' : '<td></td>'}
                                        ${(software.supported == 1) ? '<td><i class="fa fa-check-square"></i></td>' : '<td></td>'}
                                    </tr>`;
    
                        } else {
                            let software = data.software[i];
                            output += `<tr>
                                        <td>${software.softwareName}</td>
                                        ${(software.licensed == 1) ? '<td><i class="fa fa-check-square"></i></td>' : '<td></td>'}
                                        ${(software.supported == 1) ? '<td><i class="fa fa-check-square"></i></td>' : '<td></td>'}
                                    </tr>`;
                        }
                    }
                    addSelectableRows();
                    return output;
                
            }
    
            function generateBranchTable(branchID) {
                    let output = ``;
                    for(var i = 0; i < data.branches.length; i++) {
                        if(data.branches[i].id == branchID) {
    
                            let branch = data.branches[i];
                            output += `<tr class="selected-row">
                                        <td>${branch.id}</td>
                                        <td>${branch.name}</td>
                                        <td>${branch.city}</td>
                                        <td>${branch.country}</td>
                                        <td>${branch.telephone}</td>
                                    </tr>`;
    
                        } else {
                            let branch = data.branches[i];
                            output += `<tr>
                                        <td>${branch.id}</td>
                                        <td>${branch.name}</td>
                                        <td>${branch.city}</td>
                                        <td>${branch.country}</td>
                                        <td>${branch.telephone}</td>
                                    </tr>`;
                        }
                    }
                    addSelectableRows();
                    return output;
            }
    

            function generateBothSpecialistTables(specialistID, externalSpecialistID) {
                    external = false;
                    if(externalSpecialistID != null) {
                        external = true;
                        externalCheckbox.checked = true;
                        if(externalSpecialistForm.classList.contains("hide-form")) {
                            externalSpecialistForm.classList.remove("hide-form");
                        }
                        if(!specialistForm.classList.contains("hide-form")) {
                            specialistForm.classList.add("hide-form");
                        }
                    } else {
                        externalCheckbox.checked = false;
                        if(specialistForm.classList.contains("hide-form")) {
                            specialistForm.classList.remove("hide-form");
                        }
                        if(!externalSpecialistForm.classList.contains("hide-form")) {
                            externalSpecialistForm.classList.add("hide-form");
                        }
                    }

                    var specialistOutput = `<tr>
                                                <th>Specialist ID</th>
                                                <th>Name</th>
                                                <th>Ext</th>
                                                <th>Expertise</th>
                                            </tr>`;
                    for(var i = 0; i < data.specialists.length; i++) {
                        if(data.specialists[i].id == specialistID) {
                            let specialist = data.specialists[i];
                            specialistOutput += `<tr class="selected-row">
                                                    <td>${specialist.id}</td>
                                                    <td>${specialist.name}</td>
                                                    <td>${specialist.ext}</td>
                                                    <td>${specialist.problemType}</td>
                                                </tr>`
                        } else {
                            let specialist = data.specialists[i];
                            specialistOutput += `<tr>
                                                    <td>${specialist.id}</td>
                                                    <td>${specialist.name}</td>
                                                    <td>${specialist.ext}</td>
                                                    <td>${specialist.problemType}</td>
                                                </tr>`
                        }
                    }
                    specialistTable.innerHTML = specialistOutput;
                    
                    var externalSpecialistOutput = `<tr>
                                                        <th>External Specialist ID</th>
                                                        <th>Name</th>
                                                        <th>Contact Number</th>
                                                        <th>Expertise</th>
                                                    </tr>`;
                    for(var i = 0; i < data.externalSpecialists.length; i++) {
                        console.log(data.externalSpecialists[i].externalID, externalSpecialistID);
                        if(data.externalSpecialists[i].externalID == externalSpecialistID) {
                            let externalSpecialist = data.externalSpecialists[i];
                            externalSpecialistOutput += `<tr class="selected-row">
                                                            <td>${externalSpecialist.externalID}</td>
                                                            <td>${externalSpecialist.name}</td>
                                                            <td>${externalSpecialist.contactNumber}</td>
                                                            <td>${externalSpecialist.expertise}</td>
                                                        </tr>`
                        } else {
                            let externalSpecialist = data.externalSpecialists[i];
                            externalSpecialistOutput += `<tr>
                                                            <td>${externalSpecialist.externalID}</td>
                                                            <td>${externalSpecialist.name}</td>
                                                            <td>${externalSpecialist.contactNumber}</td>
                                                            <td>${externalSpecialist.expertise}</td>
                                                        </tr>`
                        }
                    }
                    externalSpecialistTable.innerHTML = externalSpecialistOutput;
                    addSelectableRows();
                    
            }

            function generateProblemTypesDropdown() {    
                var problemTypes = ``;
                for(var i = 0; i < data.problemTypes.length; i++) {
                    problemTypes += `<option>${data.problemTypes[i].problemType}</option>`;
                }

                let out = `select id="problem-type-input"> 
                                ${problemTypes}
                            </select>`;     
                return out;          
            }
    
            function reportSolved(problemNumber) {
                var confirmed = confirm("Are you sure you want to report this problem solved?");
                if(confirmed) {
                    updateProblemStatus(problemNumber);
                }
            }
    
            function updateProblemStatus(problemNumber) {
                // CALL PHP FILE
                const payload = { 'problemNumber': problemNumber };
                    loadData('POST', '../../public/php/sql_update_problem_pending.php', payload, function(json) {
                        console.log(json);
                        refreshPage();
                })
            }
    
            function viewProblem(problemNumber) {
                console.log(problemNumber);
                
                // Open modal
                modal.style.display = "block";
    
                // Get all input objects 
                for(var i = 0; i < data.activeProblems.length; i++) {
                    if(data.activeProblems[i].problemNumber == problemNumber) {
                        setInputs(data.activeProblems[i]);
                    }
                }
    
    
                // Set all values
            }
    
            function setInputs(problem) {
                console.log(problem);
    
                // Text fields
                setTextInput(problemDescriptionInput, problem.description);
                setTextInput(solveMethodInput, problem.solveMethod);
                setTextInput(notesInput, problem.notes);
                setTextInput(problemTypeInput, problem.problemType);
                setTextInput(osInput, problem.OS);
                setTextInput(priorityInput, problem.priority);
    
                // Tables
                equipmentTable.innerHTML = `<tr>
                                                <th>Serial No.</th>
                                                <th>Type</th>
                                                <th>Make</th>
                                            </tr>
                                            ${generateEquipmentTable(problem.serialNumber)}`;
                softwareTable.innerHTML = `<tr>
                                                <th>Software Name</th>
                                                <th>Licensed</th>
                                                <th>Supported</th>
                                            </tr>
                                            ${generateSoftwareTable(problem.softwareName)}`;
                branchTable.innerHTML = `<tr>
                                                <th>Branch ID</th>
                                                <th>Branch Name</th>
                                                <th>City</th>
                                                <th>Country</th>
                                                <th>Telephone</th>
                                            </tr>
                                            ${generateBranchTable(problem.branchID)}`;
    
                // Checkbox
                if(problem.inPerson == "1") {
                    inPersonInput.checked = true;
                } else {
                    inPersonInput.checked = false;
                }
                
                // Retreive the search element
    
                // Genertae all the specialists and external specialists but hide the one which the specialist isn't
                generateBothSpecialistTables(problem.specialistID, problem.externalSpecialistID);
                // Add checkbox with same id everytime so you can check if onclick....
            }
    
            function setTextInput(input, value) {
                if(value != null) {
                    input.value = value;
                    console.log(input, value);
                } else {
                    input.value = "";
                }
            }   
            
            function getInputs() {
                var equipmentSelectedRow = document.querySelector("#equipment-table").getElementsByClassName("selected-row")[0];
                var softwareSelectedRow = document.querySelector("#software-table").getElementsByClassName("selected-row")[0];
                var branchSelectedRow = document.querySelector("#branch-table").getElementsByClassName("selected-row")[0];
                var specialistSelectedRow = document.querySelector("#specialist-table").getElementsByClassName("selected-row")[0];
                var externalSpecialistSelectedRow = document.querySelector("#external-specialist-table").getElementsByClassName("selected-row")[0];

                var inputs = {
                    description: problemDescriptionInput.value, 
                    solveMethod: solveMethodInput.value, 
                    notes: notesInput.value, 
                    problemType: problemTypeInput.value, 
                    OS: osInput.value, 
                    priority: priorityInput.value, 
                }

                if(inPersonInput.checked) {
                    inputs.inPerson = 1;
                } else {
                    inputs.inPerson = 0;
                }

                if(equipmentSelectedRow != null) {
                    inputs.serialNumber = equipmentSelectedRow.cells[0].innerHTML;
                } else {
                    inputs.serialNumber = null;
                }

                if(softwareSelectedRow != null) {
                    inputs.softwareName = softwareSelectedRow.cells[0].innerHTML;
                } else {
                    inputs.softwareName = null;
                }

                if(branchSelectedRow != null) {
                    inputs.branchID = branchSelectedRow.cells[0].innerHTML;
                } else {
                    inputs.branchID = null;
                }

                if(external) {
                    inputs.specialistID = null;
                    if(externalSpecialistSelectedRow != null) {
                        inputs.externalSpecialistID = externalSpecialistSelectedRow.cells[0].innerHTML;
                    } else {
                        inputs.externalSpecialistID = null;
                    }
                } else {
                    if(specialistSelectedRow != null) { 
                        inputs.specialistID = specialistSelectedRow.cells[0].innerHTML;
                    } else {
                        inputs.specialistID = null;
                    }
                    inputs.externalSpecialist = null;
                }

                return inputs;
            }

            function confirmEdit() {
                var inputs = getInputs();
                const validatedInputs = validateInputs(inputs);
                console.log(validateInputs);
                if(typeof(validatedInputs) != "string") {
                    var confirmed = confirm("Are you sure you want to edit this data?");
                    if(confirmed) {
                        updateProblem(validatedInputs);
                    }
                } else {
                    alert(validatedInputs);
                }
            }

            function validateInputs(inputs) {
                if(inputs.branchID == null) {
                    return "branch ID is null"
                } else if (inputs.description == null) {
                    return "description is null"
                } else if(inputs.serialNumber == null){
                    return "serial number is null"
                } else if (inputs.problemType == null) {
                    return "problem type null";
                } else if(inputs.specialistID == null && inputs.externalSpecialistID == null) {
                    return "select a specialist"
                } else {
                    return inputs;
                }
            }

            function updateProblem(problem) {
                const payload = { "problemNumber": problem.problemNumber,  
                                  "branchID": problem.branchID, 
                                  "description": problem.description, 
                                  "externalSpecialistID": problem.externalSpecialistID, 
                                  "inPerson": problem.inPerson, 
                                  "solveNotes": problem.solveNotes, 
                                  "priority": problem.priority, 
                                  "problemType": problem.problemType, 
                                  "serialNumber": problem.serialNumber, 
                                  "softwareName": problem.softwareName, 
                                  "solveMethod": problem.solveMethod, 
                                  "specialistID": problem.specialistID  
                };
                loadData('POST', '../php/activeProblems/sql_update_problem.php', payload, function(json) {
                    console.log(json);
                    refreshPage();
                })
            }
    
        </script>


    <script src="../../public/js/navs.js"></script>
    <script src="../../public/js/cssHelpers.js"></script>
</body>
</html>